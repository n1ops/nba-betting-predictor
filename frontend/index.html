<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA Predictor ‚Äî Over/Under Engine</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #16161f;
            --bg-card-hover: #1c1c28;
            --border: #2a2a3a;
            --text-primary: #e8e8f0;
            --text-secondary: #8888a0;
            --text-muted: #555568;
            --accent-green: #00e88f;
            --accent-green-dim: #00e88f22;
            --accent-red: #ff4466;
            --accent-red-dim: #ff446622;
            --accent-yellow: #ffaa00;
            --accent-yellow-dim: #ffaa0022;
            --accent-blue: #4488ff;
            --accent-blue-dim: #4488ff22;
            --accent-purple: #aa66ff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ===== AMBIENT BACKGROUND ===== */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(ellipse at 20% 20%, #00e88f08 0%, transparent 50%),
                        radial-gradient(ellipse at 80% 80%, #4488ff06 0%, transparent 50%),
                        radial-gradient(ellipse at 50% 50%, #aa66ff04 0%, transparent 40%);
            animation: ambientShift 30s ease-in-out infinite alternate;
            z-index: 0;
            pointer-events: none;
        }

        @keyframes ambientShift {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(-5%, -5%) rotate(3deg); }
        }

        /* ===== HEADER ===== */
        .header {
            position: relative;
            z-index: 10;
            padding: 24px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(20px);
            background: #0a0a0fcc;
            position: sticky;
            top: 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .logo-icon {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 800;
            color: var(--bg-primary);
        }

        .logo-text {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .logo-text span {
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-meta {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
            display: inline-block;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 #00e88f44; }
            50% { opacity: 0.7; box-shadow: 0 0 0 6px #00e88f00; }
        }

        /* ===== MAIN LAYOUT ===== */
        .main {
            position: relative;
            z-index: 5;
            max-width: 1400px;
            margin: 0 auto;
            padding: 28px 32px;
        }

        /* ===== NAV TABS ===== */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 28px;
            background: var(--bg-secondary);
            border-radius: 14px;
            padding: 4px;
            width: fit-content;
        }

        .tab {
            padding: 10px 22px;
            border-radius: 11px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
            border: none;
            background: none;
            font-family: inherit;
        }

        .tab:hover { color: var(--text-primary); }

        .tab.active {
            background: var(--bg-card);
            color: var(--text-primary);
            box-shadow: 0 2px 8px #00000040;
        }

        /* ===== STATS BAR ===== */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.25s;
        }

        .stat-card:hover {
            border-color: var(--accent-green);
            transform: translateY(-2px);
        }

        .stat-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 28px;
            font-weight: 700;
        }

        .stat-sub {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* ===== FILTERS ===== */
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 7px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-family: inherit;
        }

        .filter-btn:hover { border-color: var(--text-secondary); color: var(--text-primary); }
        .filter-btn.active { border-color: var(--accent-green); color: var(--accent-green); background: var(--accent-green-dim); }

        /* ===== PREDICTIONS TABLE ===== */
        .predictions-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .pred-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr 0.8fr 1.2fr;
            padding: 12px 20px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pred-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr 0.8fr 1.2fr;
            padding: 16px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .pred-row:hover {
            border-color: var(--accent-blue);
            background: var(--bg-card-hover);
            transform: translateX(4px);
        }

        .player-info .player-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
        }

        .player-info .matchup {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        .pred-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 15px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-over { background: var(--accent-green-dim); color: var(--accent-green); }
        .badge-under { background: var(--accent-red-dim); color: var(--accent-red); }
        .badge-hold { background: #ffffff08; color: var(--text-muted); }

        .confidence-high { color: var(--accent-green); }
        .confidence-medium { color: var(--accent-yellow); }
        .confidence-low { color: var(--text-muted); }

        .edge-positive { color: var(--accent-green); }
        .edge-negative { color: var(--accent-red); }

        .method-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .method-ensemble { background: #aa66ff18; color: var(--accent-purple); }
        .method-weighted_avg { background: #4488ff12; color: var(--accent-blue); opacity: 0.7; }

        .trend-up::before { content: '‚Üë '; color: var(--accent-green); }
        .trend-down::before { content: '‚Üì '; color: var(--accent-red); }

        /* ===== CONFIDENCE BAR ===== */
        .conf-bar-wrap {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .conf-bar {
            flex: 1;
            height: 6px;
            background: #ffffff0a;
            border-radius: 3px;
            overflow: hidden;
        }

        .conf-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* ===== ACCURACY PANEL ===== */
        .accuracy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .accuracy-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
        }

        .accuracy-card h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .accuracy-ring {
            width: 140px;
            height: 140px;
            margin: 0 auto 16px;
            position: relative;
        }

        .accuracy-ring svg { transform: rotate(-90deg); }

        .accuracy-ring-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .accuracy-ring-label .pct {
            font-family: 'JetBrains Mono', monospace;
            font-size: 32px;
            font-weight: 700;
        }

        .accuracy-ring-label .sub {
            font-size: 11px;
            color: var(--text-muted);
        }

        .accuracy-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ffffff06;
            font-size: 14px;
        }

        .accuracy-row:last-child { border-bottom: none; }

        /* ===== PLAYER DETAIL MODAL ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000aa;
            backdrop-filter: blur(8px);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .game-log-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .game-log-table th {
            text-align: left;
            padding: 8px;
            color: var(--text-muted);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        .game-log-table td {
            padding: 8px;
            font-family: 'JetBrains Mono', monospace;
            border-bottom: 1px solid #ffffff06;
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
        }

        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
        .empty-state h3 { font-size: 20px; margin-bottom: 8px; color: var(--text-primary); }

        /* ===== LOADING ===== */
        .loading {
            text-align: center;
            padding: 60px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ===== DEMO BANNER ===== */
        .demo-banner {
            background: linear-gradient(135deg, var(--accent-blue-dim), var(--accent-purple)22);
            border: 1px solid var(--accent-blue);
            border-radius: 12px;
            padding: 16px 24px;
            margin-bottom: 24px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .demo-banner strong { color: var(--accent-blue); }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .header { padding: 16px; }
            .main { padding: 16px; }
            .pred-header { display: none; }
            .pred-row {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto auto;
                gap: 8px;
            }
            .stats-bar { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

<header class="header">
    <div class="logo">
        <div class="logo-icon">üèÄ</div>
        <div class="logo-text">NBA <span>Predictor</span></div>
    </div>
    <div class="header-meta">
        <span><span class="live-dot"></span> Live Engine</span>
        <span id="currentDate"></span>
    </div>
</header>

<main class="main">
    <!-- Navigation Tabs -->
    <div class="tabs">
        <button class="tab active" data-tab="picks">Today's Picks</button>
        <button class="tab" data-tab="accuracy">Accuracy</button>
        <button class="tab" data-tab="about">How It Works</button>
    </div>

    <!-- ===== PICKS TAB ===== -->
    <section id="tab-picks">
        <!-- Summary Stats -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-label">Total Predictions</div>
                <div class="stat-value" id="totalPredictions">‚Äî</div>
                <div class="stat-sub">Player props + team totals</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">High Confidence</div>
                <div class="stat-value confidence-high" id="highConfCount">‚Äî</div>
                <div class="stat-sub">Strong edge picks</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Games Today</div>
                <div class="stat-value" id="gamesToday">‚Äî</div>
                <div class="stat-sub" id="gamesDetail"></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ML Ensemble</div>
                <div class="stat-value" style="color: var(--accent-purple);" id="mlCount">‚Äî</div>
                <div class="stat-sub" id="mlDetail">ML-enhanced predictions</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Model Accuracy</div>
                <div class="stat-value" id="overallAccuracy">‚Äî</div>
                <div class="stat-sub">Last 30 days</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="pts">Points</button>
            <button class="filter-btn" data-filter="reb">Rebounds</button>
            <button class="filter-btn" data-filter="ast">Assists</button>
            <button class="filter-btn" data-filter="fg3m">3-Pointers</button>
            <button class="filter-btn" data-filter="pra">PRA</button>
            <button class="filter-btn" data-filter="high">üî• High Conf Only</button>
            <button class="filter-btn" data-filter="ensemble">üß† ML Ensemble</button>
            <button class="filter-btn" data-filter="wa_only">üìä Weighted Avg Only</button>
        </div>

        <!-- Predictions Table -->
        <div class="pred-header">
            <span>Player</span>
            <span>Stat</span>
            <span>Prediction</span>
            <span>Line</span>
            <span>Edge</span>
            <span>Confidence</span>
            <span>Method</span>
            <span>Pick</span>
        </div>
        <div class="predictions-grid" id="predictionsGrid">
            <div class="loading">
                <div class="spinner"></div>
                <div style="color: var(--text-secondary);">Loading predictions...</div>
            </div>
        </div>
    </section>

    <!-- ===== ACCURACY TAB ===== -->
    <section id="tab-accuracy" style="display: none;">
        <div class="accuracy-grid" id="accuracyGrid">
            <div class="loading">
                <div class="spinner"></div>
                <div style="color: var(--text-secondary);">Loading accuracy data...</div>
            </div>
        </div>
    </section>

    <!-- ===== ABOUT TAB ===== -->
    <section id="tab-about" style="display: none;">
        <div class="accuracy-card" style="max-width: 800px;">
            <h3>How the Prediction Engine Works</h3>
            <div style="line-height: 1.8; color: var(--text-secondary); font-size: 15px;">
                <p style="margin-bottom: 16px;">
                    The NBA Predictor uses an <strong style="color: var(--accent-purple);">ML ensemble model</strong>
                    that blends a Gradient Boosted Regressor with weighted rolling averages to project player stats
                    and identify value in over/under prop lines.
                </p>
                <p style="margin-bottom: 16px;">
                    <strong style="color: var(--accent-green);">Data Pipeline (Daily):</strong><br>
                    Every day at 10 AM UTC, the engine pulls box scores and advanced stats (pace, usage rate,
                    defensive rating, true shooting %) from the balldontlie API. Raw data is stored in S3,
                    then processed into rolling averages, trends, and consistency scores in DynamoDB.
                </p>
                <p style="margin-bottom: 16px;">
                    <strong style="color: var(--accent-purple);">ML Model (Weekly Training):</strong><br>
                    A <code style="background: var(--bg-primary); padding: 2px 8px; border-radius: 4px;">GradientBoostingRegressor</code>
                    is trained weekly on 26 features including rolling averages (3/5/10 game windows), player usage rate,
                    opponent defensive rating, pace, home/away splits, rest days, and team injury context.
                    Separate models are trained for points, rebounds, assists, and 3-pointers.
                </p>
                <p style="margin-bottom: 16px;">
                    <strong style="color: var(--accent-blue);">Ensemble Prediction:</strong><br>
                    The final prediction blends: <code style="background: var(--bg-primary); padding: 2px 8px; border-radius: 4px;">
                    60% ML Model + 40% Weighted Average</code>. The weighted average uses Last 5 (45%) + Last 10 (30%) + Last 20 (25%)
                    with trend adjustments. This ensemble approach captures the ML model's ability to factor in game context
                    while the weighted average provides stability against overfitting.
                </p>
                <p style="margin-bottom: 16px;">
                    <strong style="color: var(--accent-yellow);">Confidence Levels:</strong><br>
                    <span style="color: var(--accent-green);">HIGH</span> ‚Äî Strong edge (15%+ deviation from line) + consistent performer<br>
                    <span style="color: var(--accent-yellow);">MEDIUM</span> ‚Äî Moderate edge (8-15%) or moderate consistency<br>
                    <span style="color: var(--text-muted);">LOW</span> ‚Äî Small edge or inconsistent performer
                </p>
                <p>
                    <strong style="color: var(--text-primary);">Tech Stack:</strong><br>
                    AWS Lambda ¬∑ DynamoDB ¬∑ S3 ¬∑ EventBridge ¬∑ API Gateway ¬∑ scikit-learn ¬∑ The Odds API
                </p>
            </div>
        </div>
    </section>
</main>

<!-- Player Detail Modal -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <div class="modal-header">
            <div>
                <h2 id="modalPlayerName" style="font-size: 20px; font-weight: 700;"></h2>
                <div id="modalPlayerMeta" style="color: var(--text-secondary); font-size: 14px;"></div>
            </div>
            <button class="modal-close" onclick="closeModal()">‚úï</button>
        </div>
        <div id="modalContent"></div>
    </div>
</div>

<script>
// ==============================================
// CONFIG ‚Äî Update this after deploying your SAM stack
// ==============================================
const API_BASE = 'https://x1x4k5vr3e.execute-api.us-east-1.amazonaws.com/prod'; 

// Demo data for when API is not connected
const DEMO_DATA = {
    date: new Date().toISOString().split('T')[0],
    total_predictions: 47,
    player_props: [
        { player_name: "Jayson Tatum", team_abbr: "BOS", stat: "pts", stat_label: "Points", matchup: "MIL @ BOS", prediction: 28.4, line: 25.5, edge_pct: 11.4, recommendation: "OVER", confidence_score: 82, confidence_label: "HIGH", trend: 8.2, prediction_method: "ensemble", ml_prediction: 29.1, wa_prediction: 27.3, breakdown: { last_5_avg: 29.8, last_10_avg: 27.6, last_20_avg: 26.9 } },
        { player_name: "Luka Doncic", team_abbr: "DAL", stat: "ast", stat_label: "Assists", matchup: "DAL @ LAL", prediction: 9.2, line: 8.0, edge_pct: 15.0, recommendation: "OVER", confidence_score: 78, confidence_label: "HIGH", trend: 5.1, prediction_method: "ensemble", ml_prediction: 9.5, wa_prediction: 8.7, breakdown: { last_5_avg: 9.8, last_10_avg: 9.0, last_20_avg: 8.6 } },
        { player_name: "Nikola Jokic", team_abbr: "DEN", stat: "reb", stat_label: "Rebounds", matchup: "DEN @ PHX", prediction: 13.1, line: 11.5, edge_pct: 13.9, recommendation: "OVER", confidence_score: 85, confidence_label: "HIGH", trend: 3.4, prediction_method: "ensemble", ml_prediction: 13.4, wa_prediction: 12.6, breakdown: { last_5_avg: 13.6, last_10_avg: 12.8, last_20_avg: 12.4 } },
        { player_name: "Stephen Curry", team_abbr: "GSW", stat: "fg3m", stat_label: "3-Pointers Made", matchup: "GSW @ SAC", prediction: 4.1, line: 4.5, edge_pct: -8.9, recommendation: "UNDER", confidence_score: 62, confidence_label: "MEDIUM", trend: -4.3, prediction_method: "ensemble", ml_prediction: 3.9, wa_prediction: 4.4, breakdown: { last_5_avg: 3.8, last_10_avg: 4.2, last_20_avg: 4.4 } },
        { player_name: "Anthony Edwards", team_abbr: "MIN", stat: "pts", stat_label: "Points", matchup: "MIN @ OKC", prediction: 25.7, line: 24.5, edge_pct: 4.9, recommendation: "HOLD", confidence_score: 45, confidence_label: "LOW", trend: 1.2, prediction_method: "weighted_avg", ml_prediction: null, wa_prediction: 25.7, breakdown: { last_5_avg: 26.2, last_10_avg: 25.4, last_20_avg: 25.1 } },
        { player_name: "Tyrese Haliburton", team_abbr: "IND", stat: "ast", stat_label: "Assists", matchup: "IND @ CLE", prediction: 10.8, line: 9.5, edge_pct: 13.7, recommendation: "OVER", confidence_score: 74, confidence_label: "MEDIUM", trend: 6.8, prediction_method: "ensemble", ml_prediction: 11.2, wa_prediction: 10.2, breakdown: { last_5_avg: 11.2, last_10_avg: 10.4, last_20_avg: 10.0 } },
        { player_name: "Shai Gilgeous-Alexander", team_abbr: "OKC", stat: "pts", stat_label: "Points", matchup: "MIN @ OKC", prediction: 31.2, line: 29.5, edge_pct: 5.8, recommendation: "HOLD", confidence_score: 52, confidence_label: "MEDIUM", trend: 2.1, prediction_method: "ensemble", ml_prediction: 31.8, wa_prediction: 30.3, breakdown: { last_5_avg: 32.0, last_10_avg: 30.8, last_20_avg: 30.2 } },
        { player_name: "LeBron James", team_abbr: "LAL", stat: "pra", stat_label: "Pts+Reb+Ast", matchup: "DAL @ LAL", prediction: 40.5, line: 42.5, edge_pct: -4.7, recommendation: "HOLD", confidence_score: 38, confidence_label: "LOW", trend: -2.8, prediction_method: "weighted_avg", ml_prediction: null, wa_prediction: 40.5, breakdown: { last_5_avg: 39.8, last_10_avg: 40.8, last_20_avg: 41.2 } },
    ],
    team_totals: [
        { team_abbr: "BOS", team_name: "Boston Celtics", matchup: "MIL @ BOS", prediction: 118.4, last_5_avg: 120.2, last_10_avg: 117.8 },
        { team_abbr: "MIL", team_name: "Milwaukee Bucks", matchup: "MIL @ BOS", prediction: 114.2, last_5_avg: 112.8, last_10_avg: 115.1 },
    ],
    high_confidence: [],
};

const DEMO_ACCURACY = {
    total_predictions: 342,
    correct: 198,
    accuracy_pct: 57.9,
    by_confidence: {
        HIGH: { total: 89, correct: 58, accuracy_pct: 65.2 },
        MEDIUM: { total: 134, correct: 76, accuracy_pct: 56.7 },
        LOW: { total: 119, correct: 64, accuracy_pct: 53.8 },
    },
    by_stat: {
        pts: { total: 95, correct: 57, accuracy_pct: 60.0 },
        reb: { total: 68, correct: 39, accuracy_pct: 57.4 },
        ast: { total: 72, correct: 43, accuracy_pct: 59.7 },
        fg3m: { total: 54, correct: 28, accuracy_pct: 51.9 },
        pra: { total: 53, correct: 31, accuracy_pct: 58.5 },
    },
    days_tracked: 30,
};

// ==============================================
// STATE
// ==============================================
let predictions = null;
let accuracy = null;
let activeFilter = 'all';

// ==============================================
// INIT
// ==============================================
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('currentDate').textContent = formatDate(new Date());
    setupTabs();
    setupFilters();
    loadPredictions();
    loadAccuracy();
    document.getElementById('modalOverlay').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeModal();
    });
});

function formatDate(d) {
    return d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
}

// ==============================================
// DATA FETCHING
// ==============================================
async function fetchAPI(endpoint) {
    if (!API_BASE) return null;
    try {
        const resp = await fetch(`${API_BASE}${endpoint}`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        return await resp.json();
    } catch (e) {
        console.warn(`API call failed: ${e.message}`);
        return null;
    }
}

async function loadPredictions() {
    const data = await fetchAPI('/predictions');
    predictions = data || DEMO_DATA;

    // Update summary stats
    document.getElementById('totalPredictions').textContent = predictions.player_props?.length || 0;
    const highConf = predictions.player_props?.filter(p => p.confidence_label === 'HIGH') || [];
    document.getElementById('highConfCount').textContent = highConf.length;

    const matchups = new Set(predictions.player_props?.map(p => p.matchup) || []);
    document.getElementById('gamesToday').textContent = matchups.size;
    document.getElementById('gamesDetail').textContent = [...matchups].slice(0, 3).join(', ');

    const ensembleCount = predictions.player_props?.filter(p => p.prediction_method === 'ensemble').length || 0;
    const waCount = predictions.player_props?.filter(p => p.prediction_method !== 'ensemble').length || 0;
    document.getElementById('mlCount').textContent = ensembleCount;
    document.getElementById('mlDetail').textContent = `${waCount} weighted avg`;

    renderPredictions();
}

async function loadAccuracy() {
    const data = await fetchAPI('/accuracy');
    accuracy = data || DEMO_ACCURACY;
    document.getElementById('overallAccuracy').textContent =
        accuracy.accuracy_pct ? `${accuracy.accuracy_pct}%` : '‚Äî';
}

// ==============================================
// RENDERING
// ==============================================
function renderPredictions() {
    const grid = document.getElementById('predictionsGrid');
    let props = predictions.player_props || [];

    // Apply filter
    if (activeFilter === 'high') {
        props = props.filter(p => p.confidence_label === 'HIGH');
    } else if (activeFilter === 'ensemble') {
        props = props.filter(p => p.prediction_method === 'ensemble');
    } else if (activeFilter === 'wa_only') {
        props = props.filter(p => p.prediction_method !== 'ensemble');
    } else if (activeFilter !== 'all') {
        props = props.filter(p => p.stat === activeFilter);
    }

    if (props.length === 0) {
        grid.innerHTML = `
            <div class="empty-state">
                <div class="icon">üìä</div>
                <h3>No predictions match this filter</h3>
                <div>Try a different filter or check back when games are scheduled.</div>
            </div>`;
        return;
    }

    grid.innerHTML = props.map(p => {
        const method = p.prediction_method || 'weighted_avg';
        const methodLabel = method === 'ensemble' ? 'üß† ML' : 'üìä WA';
        return `
        <div class="pred-row" onclick="showPlayerDetail('${p.player_name}', ${JSON.stringify(p).replace(/"/g, '&quot;')})">
            <div class="player-info">
                <div class="player-name">${p.player_name}</div>
                <div class="matchup">${p.team_abbr} ¬∑ ${p.matchup}</div>
            </div>
            <div class="pred-value" style="color: var(--accent-blue);">${p.stat_label}</div>
            <div class="pred-value">${p.prediction}</div>
            <div class="pred-value" style="color: var(--text-secondary);">${p.line ?? '‚Äî'}</div>
            <div class="pred-value ${p.edge_pct > 0 ? 'edge-positive' : 'edge-negative'}">
                ${p.edge_pct > 0 ? '+' : ''}${p.edge_pct ?? 0}%
            </div>
            <div>
                <div class="conf-bar-wrap">
                    <span class="pred-value confidence-${p.confidence_label?.toLowerCase()}" style="font-size:12px; min-width: 28px;">
                        ${Math.round(p.confidence_score)}
                    </span>
                    <div class="conf-bar">
                        <div class="conf-bar-fill" style="width: ${p.confidence_score}%; background: ${
                            p.confidence_label === 'HIGH' ? 'var(--accent-green)' :
                            p.confidence_label === 'MEDIUM' ? 'var(--accent-yellow)' : 'var(--text-muted)'
                        };"></div>
                    </div>
                </div>
            </div>
            <div>
                <span class="method-badge method-${method}">${methodLabel}</span>
            </div>
            <div>
                <span class="badge badge-${p.recommendation?.toLowerCase()}">${p.recommendation === 'OVER' ? '‚ñ≤ OVER' : p.recommendation === 'UNDER' ? '‚ñº UNDER' : '‚Äî HOLD'}</span>
            </div>
        </div>
    `}).join('');
}

function renderAccuracy() {
    const grid = document.getElementById('accuracyGrid');
    if (!accuracy) { grid.innerHTML = '<div class="empty-state"><h3>No accuracy data yet</h3></div>'; return; }

    const pct = accuracy.accuracy_pct || 0;
    const circumference = 2 * Math.PI * 56;
    const offset = circumference - (pct / 100) * circumference;

    const confRows = Object.entries(accuracy.by_confidence || {}).map(([level, d]) => `
        <div class="accuracy-row">
            <span class="confidence-${level.toLowerCase()}" style="font-weight:600;">${level}</span>
            <span style="font-family: 'JetBrains Mono', monospace;">${d.accuracy_pct}% <span style="color:var(--text-muted)">(${d.correct}/${d.total})</span></span>
        </div>
    `).join('');

    const statRows = Object.entries(accuracy.by_stat || {}).map(([stat, d]) => `
        <div class="accuracy-row">
            <span style="text-transform: uppercase; font-weight: 500;">${stat === 'pra' ? 'PRA' : stat === 'fg3m' ? '3PT' : stat}</span>
            <span style="font-family: 'JetBrains Mono', monospace;">${d.accuracy_pct}% <span style="color:var(--text-muted)">(${d.correct}/${d.total})</span></span>
        </div>
    `).join('');

    grid.innerHTML = `
        <div class="accuracy-card">
            <h3>Overall Accuracy (30 Days)</h3>
            <div class="accuracy-ring">
                <svg width="140" height="140">
                    <circle cx="70" cy="70" r="56" fill="none" stroke="#ffffff08" stroke-width="10"/>
                    <circle cx="70" cy="70" r="56" fill="none" stroke="var(--accent-green)" stroke-width="10"
                        stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" stroke-linecap="round"/>
                </svg>
                <div class="accuracy-ring-label">
                    <div class="pct">${pct}%</div>
                    <div class="sub">${accuracy.correct}/${accuracy.total_predictions}</div>
                </div>
            </div>
            <div style="text-align:center; color: var(--text-secondary); font-size: 13px;">
                ${pct >= 55 ? '‚úÖ Profitable zone (>55%)' : '‚ö†Ô∏è Below profitable threshold'}
            </div>
        </div>
        <div class="accuracy-card">
            <h3>By Confidence Level</h3>
            ${confRows || '<div style="color:var(--text-muted)">No data yet</div>'}
        </div>
        <div class="accuracy-card">
            <h3>By Stat Type</h3>
            ${statRows || '<div style="color:var(--text-muted)">No data yet</div>'}
        </div>
    `;
}

// ==============================================
// INTERACTIONS
// ==============================================
function setupTabs() {
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            const target = tab.dataset.tab;
            document.querySelectorAll('[id^="tab-"]').forEach(s => s.style.display = 'none');
            document.getElementById(`tab-${target}`).style.display = 'block';
            if (target === 'accuracy') renderAccuracy();
        });
    });
}

function setupFilters() {
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            activeFilter = btn.dataset.filter;
            renderPredictions();
        });
    });
}

function showPlayerDetail(name, pred) {
    const overlay = document.getElementById('modalOverlay');
    document.getElementById('modalPlayerName').textContent = pred.player_name;
    document.getElementById('modalPlayerMeta').textContent = `${pred.team_abbr} ¬∑ ${pred.matchup}`;

    const bd = pred.breakdown || {};
    const method = pred.prediction_method || 'weighted_avg';
    const methodLabel = method === 'ensemble' ? 'üß† ML Ensemble (60% ML + 40% WA)' : 'üìä Weighted Average Only';
    const mlPred = pred.ml_prediction;
    const waPred = pred.wa_prediction;

    document.getElementById('modalContent').innerHTML = `
        <div style="margin-bottom: 16px; padding: 10px 14px; border-radius: 8px; background: ${method === 'ensemble' ? '#aa66ff10' : '#4488ff08'}; border: 1px solid ${method === 'ensemble' ? '#aa66ff30' : '#4488ff15'};">
            <span style="font-size: 13px; color: ${method === 'ensemble' ? 'var(--accent-purple)' : 'var(--accent-blue)'}; font-weight: 600;">${methodLabel}</span>
            ${method === 'ensemble' && mlPred ? `
                <div style="display: flex; gap: 20px; margin-top: 8px; font-family: 'JetBrains Mono', monospace; font-size: 13px;">
                    <span style="color: var(--accent-purple);">ML: ${mlPred}</span>
                    <span style="color: var(--accent-blue);">WA: ${waPred}</span>
                    <span style="color: var(--text-secondary);">‚Üí Blend: ${pred.prediction}</span>
                </div>
            ` : ''}
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 24px;">
            <div class="stat-card">
                <div class="stat-label">Last 5 Avg</div>
                <div class="stat-value" style="font-size:22px;">${bd.last_5_avg ?? '‚Äî'}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Last 10 Avg</div>
                <div class="stat-value" style="font-size:22px;">${bd.last_10_avg ?? '‚Äî'}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Last 20 Avg</div>
                <div class="stat-value" style="font-size:22px;">${bd.last_20_avg ?? '‚Äî'}</div>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
                <div class="stat-label">Prediction</div>
                <div style="font-family: 'JetBrains Mono'; font-size: 28px; font-weight: 700; margin: 4px 0;">${pred.prediction}</div>
                <div class="stat-label" style="margin-top: 8px;">vs Line: ${pred.line ?? 'N/A'}</div>
            </div>
            <div>
                <div class="stat-label">Edge</div>
                <div style="font-family: 'JetBrains Mono'; font-size: 28px; font-weight: 700; margin: 4px 0;"
                    class="${pred.edge_pct > 0 ? 'edge-positive' : 'edge-negative'}">
                    ${pred.edge_pct > 0 ? '+' : ''}${pred.edge_pct}%
                </div>
                <div class="stat-label" style="margin-top: 8px;">
                    Trend: <span class="${pred.trend > 0 ? 'trend-up' : pred.trend < 0 ? 'trend-down' : ''}">${pred.trend}%</span>
                </div>
            </div>
        </div>
        <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
            <span class="badge badge-${pred.recommendation?.toLowerCase()}" style="font-size: 14px; padding: 8px 20px;">
                ${pred.recommendation === 'OVER' ? '‚ñ≤ OVER' : pred.recommendation === 'UNDER' ? '‚ñº UNDER' : '‚Äî HOLD'}
            </span>
            <span style="margin-left: 12px; color: var(--text-secondary); font-size: 14px;">
                Confidence: <strong class="confidence-${pred.confidence_label?.toLowerCase()}">${pred.confidence_score}</strong>
            </span>
        </div>
    `;
    overlay.classList.add('active');
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('active');
}

document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
</script>
</body>
</html>